<div class="grid">
    <!-- Header avec s√©lection entreprise -->
    <div class="col-12">
        <div class="card">
            <div class="flex justify-content-between align-items-center mb-3">
                <h3>üìä Statistiques des Remboursements par Entreprise</h3>
                <button pButton 
                        type="button" 
                        icon="pi pi-arrow-left" 
                        label="Retour au Dashboard"
                        class="p-button-outlined"
                        routerLink="/admin/dashboard">
                </button>
            </div>
            
            <div class="field">
                <label for="entreprise" class="font-medium text-900">S√©lectionner une Entreprise</label>
                <p-dropdown 
                    id="entreprise"
                    [options]="entreprises" 
                    [(ngModel)]="selectedEntreprise" 
                    (onChange)="onEntrepriseChange()"
                    placeholder="Choisir une entreprise"
                    [style]="{'width':'100%'}"
                    [disabled]="loading && !selectedEntreprise">
                </p-dropdown>
                <small class="text-500" *ngIf="loading && !selectedEntreprise">
                    <i class="pi pi-spin pi-spinner mr-2"></i>Chargement des entreprises...
                </small>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="col-12" *ngIf="loading && selectedEntreprise">
        <div class="card text-center">
            <i class="pi pi-spin pi-spinner text-4xl text-primary mb-3"></i>
            <h5>Chargement des statistiques...</h5>
        </div>
    </div>

    <!-- Error State -->
    <div class="col-12" *ngIf="error && !loading">
        <div class="card text-center">
            <i class="pi pi-exclamation-triangle text-4xl text-red-500 mb-3"></i>
            <h5 class="text-red-500">{{ error }}</h5>
            <button pButton type="button" 
                    label="R√©essayer" 
                    class="p-button-outlined p-button-danger"
                    (click)="onEntrepriseChange()">
            </button>
        </div>
    </div>

    <!-- Statistiques Cards -->
    <ng-container *ngIf="stats && !loading">
        <!-- Card 1: Nombre total de remboursements -->
        <div class="col-12 lg:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-500 font-medium mb-3">Total Remboursements</span>
                        <div class="text-900 font-medium text-xl">{{ stats.totalRemboursements }}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-blue-100 border-round" 
                         [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                        <i class="pi pi-file text-blue-500 text-xl"></i>
                    </div>
                </div>
                <span class="text-blue-500 font-medium">{{ selectedEntreprise }}</span>
            </div>
        </div>

        <!-- Card 2: Montant total rembours√© -->
        <div class="col-12 lg:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-500 font-medium mb-3">Montant Total</span>
                        <div class="text-900 font-medium text-xl">{{ formatCurrency(stats.montantTotalRemb) }}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-green-100 border-round" 
                         [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                        <i class="pi pi-dollar text-green-500 text-xl"></i>
                    </div>
                </div>
                <span class="text-green-500 font-medium">Rembours√©</span>
            </div>
        </div>

        <!-- Card 3: Moyenne par remboursement -->
        <div class="col-12 lg:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-500 font-medium mb-3">Montant Moyen</span>
                        <div class="text-900 font-medium text-xl">
                            {{ formatCurrency(stats.totalRemboursements > 0 ? stats.montantTotalRemb / stats.totalRemboursements : 0) }}
                        </div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-orange-100 border-round" 
                         [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                        <i class="pi pi-chart-bar text-orange-500 text-xl"></i>
                    </div>
                </div>
                <span class="text-orange-500 font-medium">Par remboursement</span>
            </div>
        </div>

        <!-- Card 4: Statuts -->
        <div class="col-12 lg:col-6 xl:col-3">
            <div class="card mb-0">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-500 font-medium mb-3">Statuts</span>
                        <div class="text-900 font-medium text-xl">{{ getObjectKeys(stats.repartitionParStatut).length }}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-purple-100 border-round" 
                         [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                        <i class="pi pi-info-circle text-purple-500 text-xl"></i>
                    </div>
                </div>
                <span class="text-purple-500 font-medium">Types diff√©rents</span>
            </div>
        </div>

        <!-- Graphique remboursements par mois -->
        <div class="col-12 xl:col-6">
            <div class="card">
                <div class="flex justify-content-between align-items-center mb-3">
                    <h5>Remboursements par Mois</h5>
                    <div class="flex align-items-center gap-2">
                        <label for="annee" class="text-sm font-medium">Ann√©e:</label>
                        <p-dropdown 
                            id="annee"
                            [options]="anneesDisponibles"
                            [(ngModel)]="selectedAnnee"
                            (onChange)="onAnneeChange()"
                            placeholder="S√©lectionner"
                            [style]="{'min-width':'120px'}"
                            [disabled]="!anneesDisponibles || anneesDisponibles.length === 0">
                        </p-dropdown>
                    </div>
                </div>
                <p-chart type="line" 
                         [data]="moisChartData" 
                         [options]="chartOptions"
                         height="300px">
                </p-chart>
                
                <!-- R√©sum√© sous le graphique -->
                <div class="mt-3 p-3 surface-50 border-round" *ngIf="stats">
                    <div class="grid">
                        <div class="col-6">
                            <div class="text-500 text-sm mb-1">Total {{ selectedAnnee }}</div>
                            <div class="text-900 font-bold text-xl">
 {{ getTotalMois() }}
</div>
                        </div>
                        <div class="col-6 text-right">
                            <div class="text-500 text-sm mb-1">Mois le plus actif</div>
                            <div class="text-900 font-bold text-xl">
                                {{ getMoisLePlusActif() }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graphique statuts (doughnut) -->
        <div class="col-12 xl:col-6">
            <div class="card">
                <h5>R√©partition par Statut</h5>
                <p-chart type="doughnut" 
                         [data]="statutChartData" 
                         [options]="{responsive: true, maintainAspectRatio: false}"
                         height="300px">
                </p-chart>
                
                <!-- L√©gende d√©taill√©e -->
                <div class="mt-4">
                    <div class="grid" *ngFor="let statut of getObjectKeys(stats.repartitionParStatut); let i = index">
                        <div class="col-8">
                            <div class="flex align-items-center">
                                <div class="w-1rem h-1rem border-round mr-2"
                                     [ngStyle]="{backgroundColor: i === 0 ? 'var(--blue-500)' : 
                                                                  i === 1 ? 'var(--green-500)' : 
                                                                  i === 2 ? 'var(--orange-500)' : 
                                                                  i === 3 ? 'var(--red-500)' : 'var(--purple-500)'}">
                                </div>
                                <span class="text-sm font-medium">{{ statut }}</span>
                            </div>
                        </div>
                        <div class="col-2 text-right">
                            <span class="text-900">{{ stats.repartitionParStatut[statut] }}</span>
                        </div>
                        <div class="col-2 text-right">
                            <span class="font-medium text-primary">
                                {{ getPercentage(stats.repartitionParStatut[statut], stats.totalRemboursements) }}%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des derniers remboursements -->
        <div class="col-12">
            <div class="card">
                <h5>Derniers Remboursements Effectu√©s</h5>
                <p-table [value]="stats.derniersRemboursements" 
                         [paginator]="true" 
                         [rows]="5" 
                         responsiveLayout="scroll">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>R√©f√©rence</th>
                            <th>Prestataire</th>
                            <th>Date BS</th>
                            <th>Montant BS</th>
                            <th>Montant Rembours√©</th>
                            <th>Statut</th>
                            <th>Site</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-remb>
                        <tr>
                            <td>
                                <span class="font-medium">{{ remb.refBsPhys }}</span>
                            </td>
                            <td>{{ remb.nomPrenPrest }}</td>
                            <td>{{ remb.datBs | date:'dd/MM/yyyy' }}</td>
                           <td>{{ formatCurrency(remb.mntBs) }}</td>
                        <td>
                            <span class="text-green-500 font-medium">
                            {{ formatCurrency(remb.mntBsRemb) }}
                             </span>
                         </td>

                            <td>
                                <span class="px-2 py-1 border-round text-sm font-medium"
                                      [ngClass]="{
                                          'bg-green-100 text-green-700': remb.statBs === 'VALIDE',
                                          'bg-orange-100 text-orange-700': remb.statBs === 'EN_COURS',
                                          'bg-red-100 text-red-700': remb.statBs === 'REJETE',
                                          'bg-blue-100 text-blue-700': remb.statBs === 'EN_ATTENTE'
                                      }">
                                    {{ remb.statBs }}
                                </span>
                            </td>
                            <td>{{ remb.site }}</td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="7" class="text-center">Aucun remboursement trouv√©</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </ng-container>

    <!-- Message si aucune entreprise s√©lectionn√©e -->
    <div class="col-12" *ngIf="!selectedEntreprise && !loading">
        <div class="card text-center p-6">
            <i class="pi pi-building text-6xl text-400 mb-4"></i>
            <h4 class="text-600">S√©lectionnez une entreprise pour voir les statistiques</h4>
            <p class="text-500">Utilisez le menu d√©roulant ci-dessus pour choisir une entreprise</p>
        </div>
    </div>
</div>