<div class="creer-rapport">
  <p-toast></p-toast>

  <div class="card">
    <h2 class="text-3xl font-bold mb-4">
      <i class="pi pi-file-edit mr-2"></i>
      Créer un Rapport de Contre Visite - {{ prestataire?.role }}
    </h2>

    <form [formGroup]="rapportForm" (ngSubmit)="onSubmit()">
      <!-- Sélection Adhérent par CIN avec recherche lazy -->
      <div class="grid mb-4">
        <div class="col-12 md:col-6">
          <label>Matricule de l'adhérent (CIN) <span class="text-red-500">*</span></label>
          <p-dropdown
            formControlName="matriculeAdherent"
            [options]="adherents"
            optionLabel="cin"
            optionValue="cin"
            placeholder="Tapez pour rechercher un CIN..."
            [filter]="true"
            filterBy="cin,persoName"
            (onChange)="onAdherentChange($event)"
            [showClear]="true"
            filterPlaceholder="Rechercher par CIN ou nom..."
            emptyFilterMessage="Aucun adhérent trouvé"
            [virtualScroll]="true"
            [virtualScrollItemSize]="50">
            <ng-template let-adherent pTemplate="item">
              <div class="flex align-items-center gap-2">
                <i class="pi pi-user text-primary"></i>
                <div>
                  <div class="font-bold">{{ adherent.cin }}</div>
                  <div class="text-sm text-gray-600">{{ adherent.persoName }}</div>
                </div>
              </div>
            </ng-template>
            <ng-template let-adherent pTemplate="selectedItem">
              <div *ngIf="adherent" class="flex align-items-center gap-2">
                <i class="pi pi-user text-primary"></i>
                <span class="font-bold">{{ adherent.cin }}</span> - {{ adherent.persoName }}
              </div>
            </ng-template>
          </p-dropdown>
          <small class="text-gray-500">Tapez le CIN ou le nom pour rechercher</small>
        </div>

        <div class="col-12 md:col-6">
          <label>N° du bulletin de soins (Ref BS) <span class="text-red-500">*</span></label>
          <p-dropdown
            formControlName="refBsPhys"
            [options]="remboursements"
            optionLabel="refBsPhys"
            optionValue="refBsPhys"
            placeholder="Sélectionner un bulletin"
            [filter]="true"
            filterBy="refBsPhys,nomPrenPrest"
            (onChange)="onRemboursementChange($event)"
            [disabled]="!rapportForm.value.matriculeAdherent"
            [showClear]="true"
            emptyMessage="Aucun bulletin de soins disponible">
            <ng-template let-remb pTemplate="item">
              <div class="flex align-items-center gap-2">
                <i class="pi pi-file text-primary"></i>
                <div>
                  <div class="font-bold">{{ remb.refBsPhys }}</div>
                  <div class="text-sm text-gray-600">
                    {{ remb.nomPrenPrest }} - {{ remb.datBs | date:'dd/MM/yyyy' }}
                  </div>
                </div>
              </div>
            </ng-template>
            <ng-template let-remb pTemplate="selectedItem">
              <div *ngIf="remb" class="flex align-items-center gap-2">
                <i class="pi pi-file text-primary"></i>
                <span class="font-bold">{{ remb.refBsPhys }}</span>
              </div>
            </ng-template>
          </p-dropdown>
          <small class="text-gray-500">Référence du bulletin de soins physique</small>
        </div>
      </div>

      <!-- Affichage infos complètes : Adhérent + Prestataire + Bénéficiaire -->
      <div *ngIf="selectedAdherent || selectedRemboursement || selectedBeneficiaire" 
           class="mb-4 p-4 surface-100 border-round">
        <div class="grid">
          <!-- Informations Adhérent -->
          <div *ngIf="selectedAdherent" class="col-12 md:col-4">
            <div class="flex align-items-start gap-3">
              <i class="pi pi-user text-primary text-2xl"></i>
              <div>
                <div class="text-sm text-gray-500 mb-1">Adhérent</div>
                <div class="font-bold text-lg">{{ selectedAdherent.persoName }}</div>
                <div class="text-sm text-gray-600">CIN: {{ selectedAdherent.cin }}</div>
              </div>
            </div>
          </div>

          <!-- Informations Prestataire (du remboursement) -->
          <div *ngIf="selectedRemboursement" class="col-12 md:col-4">
            <div class="flex align-items-start gap-3">
              <i class="pi pi-briefcase text-green-500 text-2xl"></i>
              <div>
                <div class="text-sm text-gray-500 mb-1">Prestataire Consulté</div>
                <div class="font-bold text-lg">{{ selectedRemboursement.nomPrenPrest }}</div>
                <div class="text-sm text-gray-600">
                  Date: {{ selectedRemboursement.datBs | date:'dd/MM/yyyy' }}
                </div>
                <div class="text-sm text-gray-600">
                  Montant: {{ selectedRemboursement.mntBs }} TND
                </div>
              </div>
            </div>
          </div>

          <!-- Informations Bénéficiaire -->
          <div *ngIf="selectedBeneficiaire" class="col-12 md:col-4">
            <div class="flex align-items-start gap-3">
              <i class="pi pi-heart text-pink-500 text-2xl"></i>
              <div>
                <div class="text-sm text-gray-500 mb-1">Bénéficiaire du Rapport</div>
                <div class="font-bold text-lg">{{ selectedBeneficiaire.nom }}</div>
                <div class="text-sm">
                  <span class="px-2 py-1 border-round text-white text-xs"
                        [ngClass]="{
                          'bg-blue-500': selectedBeneficiaire.type === 'ADHERENT',
                          'bg-purple-500': selectedBeneficiaire.type === 'CONJOINT',
                          'bg-orange-500': selectedBeneficiaire.type === 'ENFANT'
                        }">
                    {{ formatTypeBeneficiaire(selectedBeneficiaire.type) }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tableau Dentaire (Dentiste) -->
      <div *ngIf="isDentiste" class="mb-4">
        <div class="flex justify-content-between align-items-center mb-3">
          <h3 class="text-xl font-semibold m-0">
            <i class="pi pi-heart mr-2"></i>
            Tableau Dentaire
          </h3>
          <button pButton type="button" icon="pi pi-plus" label="Ajouter une ligne"
                  class="p-button-success p-button-sm" (click)="addLigneDentaire()"></button>
        </div>

        <div formArrayName="lignesDentaire">
          <div class="surface-50 border-round p-3">
            <table class="simple-dental-table w-full">
              <thead>
                <tr>
                  <th>Dent</th>
                  <th>Code Acte</th>
                  <th>Cotation</th>
                  <th>Avis Médical</th>
                  <th style="width: 80px">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let ligne of lignesDentaire.controls; let i = index" [formGroupName]="i">
                  <td><input pInputText formControlName="dent" class="w-full" placeholder="Ex: 11"/></td>
                  <td><input pInputText formControlName="codeActe" class="w-full" placeholder="Ex: DC001"/></td>
                  <td><input pInputText formControlName="cotation" class="w-full" placeholder="Ex: 50 TND"/></td>
                  <td><input pInputText formControlName="avisMedical" class="w-full" placeholder="Ex: Carie profonde"/></td>
                  <td class="text-center">
                    <button pButton type="button" icon="pi pi-trash"
                            class="p-button-danger p-button-sm p-button-text"
                            (click)="removeLigneDentaire(i)" 
                            [disabled]="lignesDentaire.length===1"
                            pTooltip="Supprimer cette ligne">
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Informations Opticien -->
      <div *ngIf="isOpticien" class="mb-4">
        <h3 class="text-xl font-semibold mb-3">
          <i class="pi pi-eye mr-2"></i>
          Informations Optique
        </h3>
        <div class="grid">
          <div class="col-12 md:col-6">
            <label>Acuité Visuelle OD (Œil Droit)</label>
            <input pInputText formControlName="acuiteVisuelleOD" 
                   placeholder="Ex: 8/10" 
                   class="w-full"/>
          </div>
          <div class="col-12 md:col-6">
            <label>Acuité Visuelle OG (Œil Gauche)</label>
            <input pInputText formControlName="acuiteVisuelleOG" 
                   placeholder="Ex: 9/10"
                   class="w-full"/>
          </div>
          <div class="col-12 md:col-6">
            <label>Prix de la Monture (TND)</label>
            <p-inputNumber formControlName="prixMonture" 
                          mode="decimal" 
                          [minFractionDigits]="2" 
                          [maxFractionDigits]="2"
                          placeholder="0.00"
                          styleClass="w-full">
            </p-inputNumber>
          </div>
          <div class="col-12 md:col-6">
            <label>Nature des Verres</label>
            <input pInputText formControlName="natureVerres" 
                   placeholder="Ex: Progressive, Anti-reflet"
                   class="w-full"/>
          </div>
          <div class="col-12 md:col-6">
            <label>Prix des Verres (TND)</label>
            <p-inputNumber formControlName="prixVerres" 
                          mode="decimal" 
                          [minFractionDigits]="2" 
                          [maxFractionDigits]="2"
                          placeholder="0.00"
                          styleClass="w-full">
            </p-inputNumber>
          </div>
        </div>
      </div>

      <!-- Observation -->
      <div class="mb-4">
        <label>Observation <span class="text-red-500">*</span></label>
        <textarea pInputTextarea 
                  formControlName="observation" 
                  rows="5" 
                  placeholder="Décrivez votre observation médicale détaillée..." 
                  class="w-full">
        </textarea>
      </div>

      <!-- Boutons -->
      <div class="flex gap-2">
        <button pButton type="submit" 
                label="Créer le Rapport" 
                icon="pi pi-check"
                [loading]="loading" 
                [disabled]="rapportForm.invalid || loading"
                class="p-button-primary">
        </button>
        <button pButton type="button" 
                label="Réinitialiser" 
                icon="pi pi-refresh"
                class="p-button-secondary" 
                (click)="resetForm()" 
                [disabled]="loading">
        </button>
      </div>
    </form>
  </div>

  <!-- Dialog de confirmation -->
  <p-dialog header="✅ Rapport créé avec succès" 
            [(visible)]="displayRapportDialog" 
            [modal]="true" 
            [style]="{width: '50vw'}"
            [draggable]="false"
            [resizable]="false">
    <div *ngIf="rapportCree" class="p-3">
      <div class="mb-3 p-3 surface-100 border-round">
        <i class="pi pi-check-circle text-green-500 text-2xl mr-2"></i>
        <strong>Le rapport a été enregistré avec succès</strong>
      </div>
      
      <div class="mb-3">
        <strong><i class="pi pi-user mr-2"></i>Bénéficiaire:</strong> 
        {{ rapportCree.beneficiaireNom }}
      </div>
      <div class="mb-3">
        <strong><i class="pi pi-file mr-2"></i>Bulletin de soins:</strong> 
        {{ rapportCree.refBsPhys }}
      </div>
      <div class="mb-3">
        <strong><i class="pi pi-calendar mr-2"></i>Date:</strong> 
        {{ rapportCree.dateRapport | date:'dd/MM/yyyy HH:mm' }}
      </div>
      <div class="mb-3">
        <strong><i class="pi pi-comment mr-2"></i>Observation:</strong> 
        <div class="mt-2 p-2 surface-50 border-round">{{ rapportCree.observation }}</div>
      </div>

      <!-- Détails dentaire -->
      <div *ngIf="isDentiste && lignesDentaireCree.length > 0" class="mb-3">
        <strong><i class="pi pi-heart mr-2"></i>Soins dentaires:</strong>
        <div class="mt-2">
          <table class="simple-dental-table w-full">
            <thead>
              <tr>
                <th>Dent</th>
                <th>Code Acte</th>
                <th>Cotation</th>
                <th>Avis</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let ligne of lignesDentaireCree">
                <td>{{ ligne.dent }}</td>
                <td>{{ ligne.codeActe }}</td>
                <td>{{ ligne.cotation }}</td>
                <td>{{ ligne.avisMedical }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Détails optique -->
      <div *ngIf="isOpticien" class="mb-3">
        <strong><i class="pi pi-eye mr-2"></i>Détails optiques:</strong>
        <div class="grid mt-2">
          <div class="col-6">OD: {{ rapportCree.acuiteVisuelleOD }}</div>
          <div class="col-6">OG: {{ rapportCree.acuiteVisuelleOG }}</div>
          <div class="col-6">Monture: {{ rapportCree.prixMonture }} TND</div>
          <div class="col-6">Verres: {{ rapportCree.prixVerres }} TND</div>
        </div>
      </div>
    </div>
    
    <ng-template pTemplate="footer">
      <button pButton 
              type="button" 
              label="Fermer" 
              icon="pi pi-times" 
              (click)="closeRapportDialog()" 
              class="p-button-secondary">
      </button>
    </ng-template>
  </p-dialog>
</div>