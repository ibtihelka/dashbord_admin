<div class="page-container">
  <div class="page-content">
    <!-- Bouton Home -->
    <div class="header-content">
      <button class="btn-back-circle" (click)="goToAccueil()" title="Retour à l'accueil">
        <i class="pi pi-home"></i>
      </button>
    </div>
    
    <div class="reclamation-container">
      
      <!-- En-tête avec bouton toggle -->
      <div class="page-header">
        <div class="header-left">
          <h1 class="page-title">
            <i class="pi pi-exclamation-circle"></i>
            Mes Réclamations
          </h1>
          <p class="page-subtitle">Gérez vos réclamations concernant vos remboursements</p>
        </div>
        
        <!-- ✅ BOUTON POUR AFFICHER/MASQUER LE FORMULAIRE -->
        <div class="header-right">
          <button 
            class="btn btn-toggle-form"
            [class.btn-active]="showForm"
            (click)="toggleForm()"
            title="{{ showForm ? 'Masquer le formulaire' : 'Afficher le formulaire' }}">
            <i class="pi" [class.pi-plus-circle]="!showForm" [class.pi-times]="showForm"></i>
            {{ showForm ? 'Masquer le formulaire' : 'Nouvelle Réclamation' }}
          </button>
        </div>
      </div>

      <!-- Messages globaux (visibles uniquement si le formulaire est masqué) -->
      <div class="alert alert-success" *ngIf="successMessage && !showForm">
        <i class="pi pi-check-circle"></i>
        {{ successMessage }}
      </div>

      <div class="alert alert-danger" *ngIf="errorMessage && !showForm">
        <i class="pi pi-times-circle"></i>
        {{ errorMessage }}
      </div>

      <!-- ✅ FORMULAIRE AVEC ANIMATION DE SLIDE -->
      <div class="form-slide-container" [class.form-visible]="showForm">
        <div class="reclamation-form-card">
          <div class="card-header">
            <h3>
              <i class="pi pi-plus-circle"></i>
              Nouvelle Réclamation
            </h3>
            <button 
              class="btn-close"
              (click)="toggleForm()"
              title="Fermer">
              <i class="pi pi-times"></i>
            </button>
          </div>
          <div class="card-content">
            <form [formGroup]="reclamationForm" (ngSubmit)="onSubmit()">
              
              <!-- Sélection du numéro de BS -->
              <div class="form-group">
                <label for="refBsPhys">
                  Numéro du BS <span class="required">*</span>
                </label>
                <select 
                  id="refBsPhys"
                  class="form-control" 
                  formControlName="refBsPhys">
                  <option value="">Sélectionnez un bulletin de soins</option>
                  <option *ngFor="let remb of remboursements" [value]="remb.refBsPhys">
                    {{ remb.refBsPhys }} - {{ remb.nomPrenPrest }} ({{ formatDate(remb.datBs) }})
                  </option>
                </select>
                <small class="error-message" *ngIf="reclamationForm.get('refBsPhys')?.invalid && reclamationForm.get('refBsPhys')?.touched">
                  Veuillez sélectionner un bulletin de soins
                </small>
                
                <!-- Compteur de réclamations -->
                
              </div>

              <!-- Message d'avertissement -->
              <div class="alert alert-warning" *ngIf="warningMessage">
               
                {{ warningMessage }}
              </div>

           

              <!-- Description -->
              <div class="form-group">
                <label for="texteReclamation">
                  Description <span class="required">*</span>
                </label>
                <textarea 
                  id="texteReclamation"
                  class="form-control" 
                  formControlName="texteReclamation"
                  rows="5"
                  placeholder="Décrivez votre réclamation en détail..."
                 [disabled]="!selectedRefBsPhysCount?.canCreate"
></textarea>
                <small class="error-message" *ngIf="reclamationForm.get('texteReclamation')?.invalid && reclamationForm.get('texteReclamation')?.touched">
                  La description est requise (minimum 10 caractères)
                </small>
              </div>

              <!-- Message de succès -->
              <div class="alert alert-success" *ngIf="successMessage">
                <i class="pi pi-check-circle"></i>
                {{ successMessage }}
              </div>

              <!-- Message d'erreur -->
              <div class="alert alert-danger" *ngIf="errorMessage">
                <i class="pi pi-times-circle"></i>
                {{ errorMessage }}
              </div>

              <!-- Boutons d'action -->
              <div class="form-actions">
                <button 
                  type="submit" 
                  class="btn btn-primary"
                  [disabled]="isSubmitDisabled()">
                  <i class="pi" [class.pi-spin]="isSubmitting" [class.pi-spinner]="isSubmitting" [class.pi-send]="!isSubmitting"></i>
                  {{ isSubmitting ? 'Envoi en cours...' : 'Enregistrer' }}
                </button>
                <button 
                  type="button" 
                  class="btn btn-secondary"
                  (click)="resetForm()"
                  [disabled]="isSubmitting">
                  <i class="pi pi-refresh"></i>
                  Réinitialiser
                </button>
              </div>

           
            </form>
          </div>
        </div>
      </div>

      <!-- Liste des réclamations -->
      <div class="reclamations-list-card">
        <div class="card-header">
          <h3>
            <i class="pi pi-list"></i>
            Historique des réclamations
            <span class="count-badge" *ngIf="reclamations.length > 0">
              {{ reclamations.length }}
            </span>
          </h3>
        </div>
        <div class="card-content">
          
          <!-- État vide -->
          <div class="empty-state" *ngIf="reclamations.length === 0 && !isLoading">
            <i class="pi pi-inbox"></i>
            <p>Aucune réclamation pour le moment</p>
          </div>

          <!-- Chargement -->
          <div class="loading-state" *ngIf="isLoading">
            <i class="pi pi-spinner pi-spin"></i>
            <p>Chargement des réclamations...</p>
          </div>

          <!-- Tableau des réclamations -->
          <div class="table-responsive" *ngIf="reclamations.length > 0 && !isLoading">
            <table class="reclamations-table">
              <thead>
                <tr>
                  <th>N° Bulletin de soins</th>
                 
                  <th>Texte Réclamation</th>
                  <th>Réponse</th>
                  <th>Date de création</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let reclamation of reclamations">
                  <td>
                    <span class="ref-badge">{{ reclamation.refBsPhys }}</span>
                  </td>
                 

                  <td>
                    <div class="text-cell">
                      {{ reclamation.texteReclamation }}
                    </div>
                  </td>
                  <td>
                    <div class="response-cell" *ngIf="reclamation.responseRec; else noResponse">
                      <i class="pi pi-check-circle response-icon"></i>
                      {{ reclamation.responseRec }}
                    </div>
                    <ng-template #noResponse>
                      <span class="no-response">
                        <i class="pi pi-clock"></i>
                        En attente
                      </span>
                    </ng-template>
                  </td>
                  <td>
                    <span class="date-cell">{{ formatDateTime(reclamation.dateCreation) }}</span>
                  </td>
                  <td>
                    <div class="action-cell">
                      <button 
                        class="btn-icon btn-delete" 
                        [class.btn-disabled]="!canDeleteReclamation(reclamation)"
                        [disabled]="!canDeleteReclamation(reclamation)"
                        (click)="deleteReclamation(reclamation.numReclamation!)"
                        [title]="canDeleteReclamation(reclamation) ? 'Supprimer' : getDeleteDisabledReason(reclamation)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                          <line x1="10" y1="11" x2="10" y2="17"/>
                          <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                      </button>
                      
                      <span class="status-badge badge-locked" 
                            *ngIf="!canDeleteReclamation(reclamation)"
                            [title]="getDeleteDisabledReason(reclamation)">
                        <i class="pi pi-lock"></i>
                        Verrouillée
                      </span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<app-client-footer></app-client-footer>

<style>
/* ✅ STYLES POUR LE HEADER */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 20px;
}

.header-left {
  flex: 1;
}

.header-right {
  display: flex;
  gap: 10px;
}

/* Bouton toggle pour le formulaire */
.btn-toggle-form {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(102, 126, 234, 0.25);
}

.btn-toggle-form:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(102, 126, 234, 0.35);
  background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
}

.btn-toggle-form:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(102, 126, 234, 0.25);
}

.btn-toggle-form.btn-active {
  background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
}

.btn-toggle-form.btn-active:hover {
  background: linear-gradient(135deg, #e91e63 0%, #f44336 100%);
}

.btn-toggle-form i {
  font-size: 1.2rem;
}

/* ✅ ANIMATION DE SLIDE POUR LE FORMULAIRE */
.form-slide-container {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.5s ease-out, margin 0.5s ease-out;
  margin-bottom: 0;
}

.form-slide-container.form-visible {
  max-height: 2000px;
  margin-bottom: 30px;
  transition: max-height 0.5s ease-in, margin 0.5s ease-in;
}

/* Compteur de réclamations */
.reclamation-counter {
  margin-top: 10px;
}

.counter-info {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 15px;
  border-radius: 6px;
  background-color: #e3f2fd;
  border-left: 4px solid #2196F3;
  font-size: 0.9rem;
}

.counter-info.counter-warning {
  background-color: #fff3e0;
  border-left-color: #ff9800;
  color: #e65100;
}

.counter-info.counter-danger {
  background-color: #ffebee;
  border-left-color: #f44336;
  color: #c62828;
}

.counter-info i {
  font-size: 1.2rem;
}

/* Responsive */
@media (max-width: 768px) {
  .page-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .header-right {
    width: 100%;
  }

  .btn-toggle-form {
    width: 100%;
    justify-content: center;
  }
}
</style>