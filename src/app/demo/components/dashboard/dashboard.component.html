<!-- dashboard.component.html -->
<div class="grid">
    <!-- Statistiques Familles - Cards en haut -->
    <div class="col-12 lg:col-6 xl:col-3" *ngIf="stats && !loading">
        <div class="card mb-0">
            <div class="flex justify-content-between mb-3">
                <div>
                    <span class="block text-500 font-medium mb-3">Total Familles</span>
                    <div class="text-900 font-medium text-xl">{{ stats.totalFamilles }}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-blue-100 border-round" [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                    <i class="pi pi-users text-blue-500 text-xl"></i>
                </div>
            </div>
            <span class="text-green-500 font-medium">{{ stats.totalFamilles }} </span>
            <span class="text-500">membres enregistr√©s</span>
        </div>
    </div>

    <div class="col-12 lg:col-6 xl:col-3" *ngIf="stats && !loading">
        <div class="card mb-0">
            <div class="flex justify-content-between mb-3">
                <div>
                    <span class="block text-500 font-medium mb-3">√Çge Moyen</span>
                    <div class="text-900 font-medium text-xl">{{ stats.moyenneAge }} ans</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-orange-100 border-round" [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                    <i class="pi pi-calendar text-orange-500 text-xl"></i>
                </div>
            </div>
            <span class="text-green-500 font-medium">{{ stats.repartitionParTrancheAge['18-35'] }} </span>
            <span class="text-500">adultes (18-35)</span>
        </div>
    </div>

   

 
    <div class="col-12 lg:col-6 xl:col-3">
    <div class="card mb-0 cursor-pointer transition-all transition-duration-150 hover:shadow-4" 
         routerLink="/admin/remboursement-stats"
         style="cursor: pointer;">
        <div class="flex justify-content-between mb-3">
            <div>
                <span class="block text-500 font-medium mb-3">Remboursements</span>
                <div class="text-900 font-medium text-xl">
                    <i class="pi pi-spin pi-spinner text-xl" *ngIf="loadingRemb"></i>
                    <span *ngIf="!loadingRemb">{{ totalRemboursements }}</span>
                </div>
            </div>
            <div class="flex align-items-center justify-content-center bg-teal-100 border-round" 
                 [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                <i class="pi pi-money-bill text-teal-500 text-xl"></i>
            </div>
        </div>
        <span class="text-green-500 font-medium">{{ nouveauxRemboursements }} nouveaux </span>
        <span class="text-500">ce mois</span>
        
        <!-- Indicateur de navigation -->
        <div class="mt-3 pt-2 border-top-1 surface-border flex align-items-center justify-content-between">
            <span class="text-primary text-sm font-medium">Voir statistiques d√©taill√©es</span>
            <i class="pi pi-arrow-right text-primary"></i>
        </div>
    </div>
</div>


<!-- Ajoutez cette nouvelle carte APR√àS la carte "√Çge Moyen" et AVANT la carte "Remboursements" -->

<!-- Card Adh√©rents (NOUVELLE) -->
<div class="col-12 lg:col-6 xl:col-3">
    <div class="card mb-0 cursor-pointer transition-all transition-duration-150 hover:shadow-4" 
         routerLink="/admin/user-stats"
         style="cursor: pointer;">
        <div class="flex justify-content-between mb-3">
            <div>
                <span class="block text-500 font-medium mb-3">Adh√©rents</span>
                <div class="text-900 font-medium text-xl">
                    <i class="pi pi-spin pi-spinner text-xl" *ngIf="loadingAdh"></i>
                    <span *ngIf="!loadingAdh">{{ totalAdherents }}</span>
                </div>
            </div>
            <div class="flex align-items-center justify-content-center bg-purple-100 border-round" 
                 [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                <i class="pi pi-users text-purple-500 text-xl"></i>
            </div>
        </div>
        <span class="text-green-500 font-medium">{{ nouveauxAdherents }} nouveaux </span>
        <span class="text-500">ce mois</span>
        
        <!-- Indicateur de navigation -->
        <div class="mt-3 pt-2 border-top-1 surface-border flex align-items-center justify-content-between">
            <span class="text-primary text-sm font-medium">Voir statistiques d√©taill√©es</span>
            <i class="pi pi-arrow-right text-primary"></i>
        </div>
    </div>
</div>





    <!-- Loading/Error States -->
    <div class="col-12" *ngIf="loading">
        <div class="card text-center">
            <i class="pi pi-spin pi-spinner text-4xl text-primary mb-3"></i>
            <h5>Chargement des statistiques...</h5>
        </div>
    </div>

    <div class="col-12" *ngIf="error && !loading">
        <div class="card text-center">
            <i class="pi pi-exclamation-triangle text-4xl text-red-500 mb-3"></i>
            <h5 class="text-red-500">{{ error }}</h5>
            <button pButton type="button" 
                    label="R√©essayer" 
                    class="p-button-outlined p-button-danger"
                    (click)="refreshStats()">
            </button>
        </div>
    </div>

    <!-- Graphiques Familles -->
    <div class="col-12 xl:col-6" *ngIf="stats && !loading">
        <div class="card">
            <div class="flex justify-content-between align-items-center mb-5">
                <h5>R√©partition par Type de Prestataire</h5>
                <div>
                    <button pButton type="button" icon="pi pi-ellipsis-v" 
                            class="p-button-rounded p-button-text p-button-plain" 
                            (click)="menu.toggle($event)">
                    </button>
                    <p-menu #menu [popup]="true" [model]="items"></p-menu>
                </div>
            </div>
            
            <!-- Graphique en secteurs -->
            <p-chart type="doughnut" 
                     [data]="familleChartData" 
                     [options]="{responsive: true, maintainAspectRatio: false}"
                     height="300px">
            </p-chart>
            
            <!-- L√©gende d√©taill√©e -->
            <div class="mt-4">
                <div class="grid" *ngFor="let type of getObjectKeys(stats.repartitionParType); let i = index">
                    <div class="col-6">
                        <div class="flex align-items-center">
                            <div class="w-1rem h-1rem border-round mr-2"
                                 [ngStyle]="{backgroundColor: i === 0 ? 'var(--blue-500)' : 
                                                              i === 1 ? 'var(--green-500)' : 
                                                              i === 2 ? 'var(--yellow-500)' : 
                                                              i === 3 ? 'var(--cyan-500)' : 'var(--pink-500)'}">
                            </div>
                            <span class="text-sm">{{ type }}: {{ stats.repartitionParType[type] }}</span>
                        </div>
                    </div>
                    <div class="col-6 text-right">
                        <span class="font-medium">{{ getPercentage(stats.repartitionParType[type], stats.totalFamilles) }}%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 xl:col-6" *ngIf="stats && !loading">
        <div class="card">
            <h5>R√©partition par Tranche d'√Çge</h5>
            <p-chart type="bar" 
                     [data]="ageChartData" 
                     [options]="{responsive: true, maintainAspectRatio: false, indexAxis: 'y'}"
                     height="300px">
            </p-chart>
            
            <!-- Liste d√©taill√©e par tranche d'√¢ge -->
            <ul class="list-none p-0 m-0 mt-4">
                <li class="flex flex-column md:flex-row md:align-items-center md:justify-content-between mb-3"
                    *ngFor="let tranche of getObjectKeys(stats.repartitionParTrancheAge); let i = index">
                    <div>
                        <span class="text-900 font-medium mr-2">{{ tranche }} ans</span>
                        <div class="mt-1 text-600">{{ stats.repartitionParTrancheAge[tranche] }} personnes</div>
                    </div>
                    <div class="mt-2 md:mt-0 flex align-items-center">
                        <div class="surface-300 border-round overflow-hidden w-10rem lg:w-6rem" 
                             [ngStyle]="{height: '8px'}">
                            <div class="bg-primary h-full" 
                                 [ngStyle]="{width: getPercentage(stats.repartitionParTrancheAge[tranche], stats.totalFamilles) + '%'}">
                            </div>
                        </div>
                        <span class="text-primary ml-3 font-medium">
                            {{ getPercentage(stats.repartitionParTrancheAge[tranche], stats.totalFamilles) }}%
                        </span>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Section originale existante -->
    <div class="col-12 lg:col-6 xl:col-3">
        <div class="card mb-0">
            <div class="flex justify-content-between mb-3">
                <div>
                    <span class="block text-500 font-medium mb-3">Orders</span>
                    <div class="text-900 font-medium text-xl">152</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-blue-100 border-round" [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                    <i class="pi pi-shopping-cart text-blue-500 text-xl"></i>
                </div>
            </div>
            <span class="text-green-500 font-medium">24 new </span>
            <span class="text-500">since last visit</span>
        </div>
    </div>

    <div class="col-12 lg:col-6 xl:col-3">
        <div class="card mb-0">
            <div class="flex justify-content-between mb-3">
                <div>
                    <span class="block text-500 font-medium mb-3">Revenue</span>
                    <div class="text-900 font-medium text-xl">$2.100</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-orange-100 border-round" [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                    <i class="pi pi-map-marker text-orange-500 text-xl"></i>
                </div>
            </div>
            <span class="text-green-500 font-medium">%52+ </span>
            <span class="text-500">since last week</span>
        </div>
    </div>

    <div class="col-12 lg:col-6 xl:col-3">
        <div class="card mb-0">
            <div class="flex justify-content-between mb-3">
                <div>
                    <span class="block text-500 font-medium mb-3">Customers</span>
                    <div class="text-900 font-medium text-xl">28441</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-cyan-100 border-round" [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                    <i class="pi pi-inbox text-cyan-500 text-xl"></i>
                </div>
            </div>
            <span class="text-green-500 font-medium">520  </span>
            <span class="text-500">newly registered</span>
        </div>
    </div>

    <div class="col-12 lg:col-6 xl:col-3">
        <div class="card mb-0">
            <div class="flex justify-content-between mb-3">
                <div>
                    <span class="block text-500 font-medium mb-3">Comments</span>
                    <div class="text-900 font-medium text-xl">152 Unread</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-purple-100 border-round" [ngStyle]="{width: '2.5rem', height: '2.5rem'}">
                    <i class="pi pi-comment text-purple-500 text-xl"></i>
                </div>
            </div>
            <span class="text-green-500 font-medium">85 </span>
            <span class="text-500">responded</span>
        </div>
    </div>

    <div class="col-12 xl:col-6">
        <div class="card">
            <h5>Recent Sales</h5>
            <p-table [value]="products" [paginator]="true" [rows]="5" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Image</th>
                        <th pSortableColumn="name">Name <p-sortIcon field="name"></p-sortIcon></th>
                        <th pSortableColumn="price">Price <p-sortIcon field="price"></p-sortIcon></th>
                        <th>View</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-product>
                    <tr>
                        <td style="width: 15%; min-width: 5rem;">
                            <img src="assets/demo/images/product/{{product.image}}" class="shadow-4" alt="{{product.name}}" width="50">
                        </td>
                        <td style="width: 35%; min-width: 7rem;">{{product.name}}</td>
                        <td style="width: 35%; min-width: 8rem;">{{product.price | currency:'USD'}}</td>
                        <td style="width: 15%;">
                            <button pButton pRipple type="button" icon="pi pi-search" class="p-button p-component p-button-text p-button-icon-only"></button>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
        <div class="card">
            <div class="flex justify-content-between align-items-center mb-5">
                <h5>Best Selling Products</h5>
                <div>
                    <button pButton type="button" icon="pi pi-ellipsis-v" class="p-button-rounded p-button-text p-button-plain" (click)="menu.toggle($event)"></button>
                    <p-menu #menu [popup]="true" [model]="items"></p-menu>
                </div>
            </div>
            <ul class="list-none p-0 m-0">
                <li class="flex flex-column md:flex-row md:align-items-center md:justify-content-between mb-4">
                    <div>
                        <span class="text-900 font-medium mr-2 mb-1 md:mb-0">Robots T-Shirt</span>
                        <div class="mt-1 text-600">Clothing</div>
                    </div>
                    <div class="mt-2 md:mt-0 ml-0 md:ml-8 flex align-items-center">
                        <div class="surface-300 border-round overflow-hidden w-10rem lg:w-6rem" [ngStyle]="{height: '8px'}">
                            <div class="bg-teal-500 h-full" [ngStyle]="{width: '40%'}"></div>
                        </div>
                        <span class="text-teal-500 ml-3 font-medium">%40</span>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <div class="col-12 xl:col-6">
        <div class="card">
            <h5>Sales Overview</h5>
            <p-chart type="line" [data]="chartData" [options]="chartOptions"></p-chart>
        </div>

        <div class="card">
            <div class="flex align-items-center justify-content-between mb-4">
                <h5>Notifications</h5>
                <div>
                    <button pButton type="button" icon="pi pi-ellipsis-v" class="p-button-rounded p-button-text p-button-plain" (click)="menu.toggle($event)"></button>
                    <p-menu #menu [popup]="true" [model]="items"></p-menu>
                </div>
            </div>

            <span class="block text-600 font-medium mb-3">TODAY</span>
            <ul class="p-0 mx-0 mt-0 mb-4 list-none">
                <li class="flex align-items-center py-2 border-bottom-1 surface-border">
                    <div class="w-3rem h-3rem flex align-items-center justify-content-center bg-blue-100 border-circle mr-3 flex-shrink-0">
                        <i class="pi pi-dollar text-xl text-blue-500"></i>
                    </div>
                    <span class="text-900 line-height-3">Richard Jones
                        <span class="text-700"> has purchased a blue t-shirt for <span class="text-blue-500">79$</span></span>
                    </span>
                </li>
                <li class="flex align-items-center py-2">
                    <div class="w-3rem h-3rem flex align-items-center justify-content-center bg-orange-100 border-circle mr-3 flex-shrink-0">
                        <i class="pi pi-download text-xl text-orange-500"></i>
                    </div>
                    <span class="text-700 line-height-3">Your request for withdrawal of <span class="text-blue-500 font-medium">2500$</span> has been initiated.</span>
                </li>
            </ul>

            <span class="block text-600 font-medium mb-3">YESTERDAY</span>
            <ul class="p-0 m-0 list-none">
                <li class="flex align-items-center py-2 border-bottom-1 surface-border">
                    <div class="w-3rem h-3rem flex align-items-center justify-content-center bg-blue-100 border-circle mr-3 flex-shrink-0">
                        <i class="pi pi-dollar text-xl text-blue-500"></i>
                    </div>
                    <span class="text-900 line-height-3">Keyser Wick
                        <span class="text-700"> has purchased a black jacket for <span class="text-blue-500">59$</span></span>
                    </span>
                </li>
                <li class="flex align-items-center py-2 border-bottom-1 surface-border">
                    <div class="w-3rem h-3rem flex align-items-center justify-content-center bg-pink-100 border-circle mr-3 flex-shrink-0">
                        <i class="pi pi-question text-xl text-pink-500"></i>
                    </div>
                    <span class="text-900 line-height-3">Jane Davis<span class="text-700"> has posted a new questions about your product.</span></span>
                </li>
            </ul>
        </div>

        <div class="px-4 py-5 shadow-2 flex flex-column md:flex-row md:align-items-center justify-content-between mb-3" 
             [ngStyle]="{borderRadius: '1rem', background: 'linear-gradient(0deg, rgba(0, 123, 255, 0.5), rgba(0, 123, 255, 0.5)), linear-gradient(92.54deg, #1C80CF 47.88%, #FFFFFF 100.01%)'}">
           <div>
               <div class="text-blue-100 font-medium text-xl mt-2 mb-3">TAKE THE NEXT STEP</div>
               <div class="text-white font-medium text-5xl">Try PrimeBlocks</div>
           </div>
           <div class="mt-4 mr-auto md:mt-0 md:mr-0">
               <a target="_blank" href="https://www.primefaces.org/primeblocks-ng" class="p-button font-bold px-5 py-3 p-button-warning p-button-rounded p-button-raised">
                   Get Started
               </a>
           </div>
        </div>
    </div>

    <!-- Section suppl√©mentaire avec informations d√©taill√©es famille -->
    <div class="col-12" *ngIf="stats && !loading">
        <div class="card">
            <div class="flex align-items-center justify-content-between mb-4">
                <h5>üìã D√©tails des Statistiques Famille</h5>
                <button pButton 
                        type="button" 
                        label="Actualiser" 
                        icon="pi pi-refresh" 
                        class="p-button-outlined p-button-sm"
                        [loading]="loading"
                        (click)="refreshStats()">
                </button>
            </div>

            <div class="grid">
                <!-- R√©partition par sexe -->
                <div class="col-12 md:col-6 lg:col-4">
                    <div class="surface-card p-4 shadow-2 border-round">
                        <div class="flex justify-content-between align-items-center mb-3">
                            <div class="text-900 font-medium text-lg">R√©partition par Sexe</div>
                            <i class="pi pi-users text-2xl text-blue-500"></i>
                        </div>
                        <ul class="list-none p-0 m-0">
                            <li class="flex align-items-center py-2 border-bottom-1 surface-border" 
                                *ngFor="let sexe of getObjectKeys(stats.repartitionParSexe); let i = index">
                                <div class="w-2rem h-2rem flex align-items-center justify-content-center border-circle mr-3 flex-shrink-0"
                                     [ngClass]="sexe === 'M' ? 'bg-blue-100' : sexe === 'F' ? 'bg-pink-100' : 'bg-gray-100'">
                                    <i class="pi text-sm"
                                       [ngClass]="sexe === 'M' ? 'pi-mars text-blue-500' : 
                                                  sexe === 'F' ? 'pi-venus text-pink-500' : 'pi-question text-gray-500'"></i>
                                </div>
                                <span class="text-900 line-height-3 flex-1">
                                    {{ sexe === 'M' ? 'Hommes' : sexe === 'F' ? 'Femmes' : 'Non d√©fini' }}
                                    <div class="text-600 text-sm">{{ stats.repartitionParSexe[sexe] }} personnes</div>
                                </span>
                                <span class="font-medium text-lg">
                                    {{ getPercentage(stats.repartitionParSexe[sexe], stats.totalFamilles) }}%
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Top types de prestataires -->
                <div class="col-12 md:col-6 lg:col-4">
                    <div class="surface-card p-4 shadow-2 border-round">
                        <div class="flex justify-content-between align-items-center mb-3">
                            <div class="text-900 font-medium text-lg">Types Prestataires</div>
                            <i class="pi pi-sitemap text-2xl text-green-500"></i>
                        </div>
                        <ul class="list-none p-0 m-0">
                            <li class="flex align-items-center py-2 border-bottom-1 surface-border"
                                *ngFor="let type of getObjectKeys(stats.repartitionParType); let i = index">
                                <div class="w-2rem h-2rem flex align-items-center justify-content-center border-circle mr-3 flex-shrink-0"
                                     [ngStyle]="{backgroundColor: i === 0 ? 'var(--blue-100)' : 
                                                                   i === 1 ? 'var(--green-100)' : 
                                                                   i === 2 ? 'var(--yellow-100)' : 'var(--cyan-100)'}">
                                    <i class="pi text-sm"
                                       [ngClass]="type === 'CONJOINT' ? 'pi-heart' :
                                                  type === 'ENFANT' ? 'pi-user' :
                                                  type === 'PERE' ? 'pi-user-plus' : 
                                                  type === 'MERE' ? 'pi-user-plus' : 'pi-users'"
                                       [ngStyle]="{color: i === 0 ? 'var(--blue-500)' : 
                                                          i === 1 ? 'var(--green-500)' : 
                                                          i === 2 ? 'var(--yellow-500)' : 'var(--cyan-500)'}">
                                    </i>
                                </div>
                                <span class="text-900 line-height-3 flex-1">
                                    {{ type }}
                                    <div class="text-600 text-sm">{{ stats.repartitionParType[type] }} personnes</div>
                                </span>
                                <span class="font-medium text-lg">
                                    {{ getPercentage(stats.repartitionParType[type], stats.totalFamilles) }}%
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Statistiques d'√¢ge -->
                <div class="col-12 md:col-12 lg:col-4">
                    <div class="surface-card p-4 shadow-2 border-round">
                        <div class="flex justify-content-between align-items-center mb-3">
                            <div class="text-900 font-medium text-lg">Analyse des √Çges</div>
                            <i class="pi pi-calendar text-2xl text-orange-500"></i>
                        </div>
                        
                        <div class="text-center mb-4">
                            <div class="text-4xl font-bold text-900 mb-2">{{ stats.moyenneAge }}</div>
                            <div class="text-600">√Çge moyen</div>
                        </div>

                        <!-- Progress bars pour chaque tranche -->
                        <div class="mb-3" *ngFor="let tranche of getObjectKeys(stats.repartitionParTrancheAge)">
                            <div class="flex justify-content-between align-items-center mb-1">
                                <span class="text-sm font-medium">{{ tranche }} ans</span>
                                <span class="text-sm">{{ stats.repartitionParTrancheAge[tranche] }}</span>
                            </div>
                            <div class="bg-gray-200 border-round overflow-hidden" style="height: 6px;">
                                <div class="bg-primary h-full border-round transition-all transition-duration-500"
                                     [ngStyle]="{width: getPercentage(stats.repartitionParTrancheAge[tranche], stats.totalFamilles) + '%'}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                   