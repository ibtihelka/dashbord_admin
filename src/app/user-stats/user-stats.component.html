<div class="grid">
    <!-- En-t√™te avec bouton retour et s√©lecteur d'entreprise -->
    <div class="col-12">
        <div class="card">
            <div class="flex flex-column lg:flex-row justify-content-between align-items-start lg:align-items-center gap-3">
                <div>
                    <h3 class="m-0">üìä Statistiques des Adh√©rents</h3>
                    <p class="text-600 mt-2 mb-0">
                        <span *ngIf="!selectedCompany">Vue globale de tous les adh√©rents</span>
                        <span *ngIf="selectedCompany">Entreprise: <strong>{{ selectedCompany }}</strong></span>
                    </p>
                </div>
                
                <!-- S√©lecteur d'entreprise -->
                <div class="flex flex-column sm:flex-row gap-2 align-items-stretch sm:align-items-center w-full lg:w-auto">
                    <div class="p-inputgroup flex-1" style="min-width: 250px;">
                        <span class="p-inputgroup-addon">
                            <i class="pi pi-building"></i>
                        </span>
                        <p-dropdown 
                            [options]="companies" 
                            [(ngModel)]="selectedCompany"
                            (onChange)="onCompanyChange()"
                            placeholder="Toutes les entreprises"
                            [showClear]="true"
                            styleClass="w-full">
                        </p-dropdown>
                    </div>
                    
                    <button pButton 
                            type="button" 
                            icon="pi pi-times" 
                            class="p-button-outlined p-button-secondary"
                            *ngIf="selectedCompany"
                            (click)="clearCompanyFilter()"
                            pTooltip="Afficher toutes les entreprises"
                            tooltipPosition="bottom">
                    </button>
                    
                    <button pButton 
                            type="button" 
                            label="Actualiser" 
                            icon="pi pi-refresh" 
                            class="p-button-outlined"
                            [loading]="loading"
                            (click)="refreshStats()">
                    </button>
                    
                    <button pButton 
                            type="button" 
                            label="Retour" 
                            icon="pi pi-arrow-left" 
                            class="p-button-outlined"
                            routerLink="/admin">
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="col-12" *ngIf="loading && !globalStats">
        <div class="card text-center">
            <i class="pi pi-spin pi-spinner text-4xl text-primary mb-3"></i>
            <h5>Chargement des statistiques...</h5>
        </div>
    </div>

    <!-- Error State -->
    <div class="col-12" *ngIf="error && !loading">
        <div class="card text-center">
            <i class="pi pi-exclamation-triangle text-4xl text-red-500 mb-3"></i>
            <h5 class="text-red-500">{{ error }}</h5>
            <button pButton 
                    type="button" 
                    label="R√©essayer" 
                    class="p-button-outlined p-button-danger"
                    (click)="refreshStats()">
            </button>
        </div>
    </div>

    <!-- Cards statistiques principales -->
    <ng-container *ngIf="globalStats && !loading">
        <div class="col-12 lg:col-6 xl:col-3">
            <div class="card mb-0 bg-primary">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-white font-medium mb-3">Total Adh√©rents</span>
                        <div class="text-white font-medium text-4xl">{{ globalStats.total }}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-white-alpha-20 border-round" 
                         [ngStyle]="{width: '3rem', height: '3rem'}">
                        <i class="pi pi-users text-white text-2xl"></i>
                    </div>
                </div>
                <span class="text-white-alpha-90">
                    <span *ngIf="selectedCompany">de l'entreprise</span>
                    <span *ngIf="!selectedCompany">Adh√©rents enregistr√©s</span>
                </span>
            </div>
        </div>

        <div class="col-12 lg:col-6 xl:col-3">
            <div class="card mb-0 bg-green-500">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-white font-medium mb-3">Nouveaux Adh√©rents</span>
                        <div class="text-white font-medium text-4xl">{{ globalStats.nouveaux }}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-white-alpha-20 border-round" 
                         [ngStyle]="{width: '3rem', height: '3rem'}">
                        <i class="pi pi-user-plus text-white text-2xl"></i>
                    </div>
                </div>
                <span class="text-white-alpha-90">Ce mois</span>
            </div>
        </div>

        <div class="col-12 lg:col-6 xl:col-3" *ngIf="detailedStats">
            <div class="card mb-0 bg-blue-500">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-white font-medium mb-3">Hommes</span>
                        <div class="text-white font-medium text-4xl">
                            {{ detailedStats.repartitionParSexe['M'] || 0 }}
                        </div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-white-alpha-20 border-round" 
                         [ngStyle]="{width: '3rem', height: '3rem'}">
                        <i class="pi pi-mars text-white text-2xl"></i>
                    </div>
                </div>
                <span class="text-white-alpha-90">
                    {{ getPercentage(detailedStats.repartitionParSexe['M'] || 0, globalStats.total) }}% du total
                </span>
            </div>
        </div>

        <div class="col-12 lg:col-6 xl:col-3" *ngIf="detailedStats">
            <div class="card mb-0 bg-pink-500">
                <div class="flex justify-content-between mb-3">
                    <div>
                        <span class="block text-white font-medium mb-3">Femmes</span>
                        <div class="text-white font-medium text-4xl">
                            {{ detailedStats.repartitionParSexe['F'] || 0 }}
                        </div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-white-alpha-20 border-round" 
                         [ngStyle]="{width: '3rem', height: '3rem'}">
                        <i class="pi pi-venus text-white text-2xl"></i>
                    </div>
                </div>
                <span class="text-white-alpha-90">
                    {{ getPercentage(detailedStats.repartitionParSexe['F'] || 0, globalStats.total) }}% du total
                </span>
            </div>
        </div>
    </ng-container>

    <!-- Graphiques -->
    <ng-container *ngIf="detailedStats && !loading">
        <!-- R√©partition par Sexe -->
        <div class="col-12 xl:col-6">
            <div class="card">
                <div class="flex justify-content-between align-items-center mb-4">
                    <h5>R√©partition par Sexe</h5>
                    <i class="pi pi-chart-pie text-2xl text-primary"></i>
                </div>
                
                <p-chart type="doughnut" 
                         [data]="sexeChartData" 
                         [options]="{responsive: true, maintainAspectRatio: false}"
                         height="300px">
                </p-chart>

                <!-- D√©tails -->
                <div class="mt-4">
                    <div class="grid" *ngFor="let sexe of getObjectKeys(detailedStats.repartitionParSexe)">
                        <div class="col-6">
                            <div class="flex align-items-center">
                                <div class="w-1rem h-1rem border-round mr-2"
                                     [ngStyle]="{backgroundColor: sexe === 'M' ? 'var(--blue-500)' : 
                                                                  sexe === 'F' ? 'var(--pink-500)' : 'var(--gray-500)'}">
                                </div>
                                <span class="text-sm">
                                    {{ sexe === 'M' ? 'Hommes' : sexe === 'F' ? 'Femmes' : 'Non d√©fini' }}: 
                                    {{ detailedStats.repartitionParSexe[sexe] }}
                                </span>
                            </div>
                        </div>
                        <div class="col-6 text-right">
                            <span class="font-medium">
                                {{ getPercentage(detailedStats.repartitionParSexe[sexe], globalStats?.total || 0) }}%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- R√©partition par Situation Familiale -->
        <div class="col-12 xl:col-6">
            <div class="card">
                <div class="flex justify-content-between align-items-center mb-4">
                    <h5>R√©partition par Situation Familiale</h5>
                    <i class="pi pi-chart-bar text-2xl text-primary"></i>
                </div>

                <p-chart type="bar" 
                         [data]="situationChartData" 
                         [options]="{responsive: true, maintainAspectRatio: false, indexAxis: 'y'}"
                         height="300px">
                </p-chart>

                <!-- Liste d√©taill√©e -->
                <ul class="list-none p-0 m-0 mt-4">
                    <li class="flex flex-column md:flex-row md:align-items-center md:justify-content-between mb-3 pb-3 border-bottom-1 surface-border"
                        *ngFor="let situation of getObjectKeys(detailedStats.repartitionParSituationFamiliale)">
                        <div class="flex align-items-center">
                            <div class="w-2rem h-2rem flex align-items-center justify-content-center border-circle mr-3"
                                 [ngClass]="'bg-' + getSituationColor(situation) + '-100'">
                                <i [ngClass]="['pi', getSituationIcon(situation), 'text-' + getSituationColor(situation) + '-500']"></i>
                            </div>
                            <div>
                                <span class="text-900 font-medium">{{ getSituationLabel(situation) }}</span>
                                <div class="text-600 text-sm">
                                    {{ detailedStats.repartitionParSituationFamiliale[situation] }} adh√©rents
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 md:mt-0 flex align-items-center">
                            <div class="surface-300 border-round overflow-hidden w-10rem" 
                                 [ngStyle]="{height: '8px'}">
                                <div [ngClass]="'bg-' + getSituationColor(situation) + '-500'" 
                                     class="h-full transition-all transition-duration-500"
                                     [ngStyle]="{width: getPercentage(detailedStats.repartitionParSituationFamiliale[situation], globalStats?.total || 0) + '%'}">
                                </div>
                            </div>
                            <span [ngClass]="'text-' + getSituationColor(situation) + '-500'" 
                                  class="ml-3 font-medium">
                                {{ getPercentage(detailedStats.repartitionParSituationFamiliale[situation], globalStats?.total || 0) }}%
                            </span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- √âvolution des adh√©sions -->
        <div class="col-12" *ngIf="evolutionChartData">
            <div class="card">
                <div class="flex justify-content-between align-items-center mb-4">
                    <h5>√âvolution des Nouveaux Adh√©rents</h5>
                    <i class="pi pi-chart-line text-2xl text-primary"></i>
                </div>
                <p-chart type="line" 
                         [data]="evolutionChartData" 
                         [options]="{responsive: true, maintainAspectRatio: false}"
                         height="250px">
                </p-chart>
            </div>
        </div>

        <!-- Tableau d√©taill√© par situation familiale -->
        <div class="col-12">
            <div class="card">
                <div class="flex justify-content-between align-items-center mb-4">
                    <h5>üìã Analyse Crois√©e: Situation Familiale</h5>
                </div>

                <div class="grid">
                    <div class="col-12 md:col-6 lg:col-3" 
                         *ngFor="let situation of getObjectKeys(detailedStats.repartitionParSituationFamiliale)">
                        <div class="surface-card p-4 shadow-2 border-round">
                            <div class="flex justify-content-between align-items-center mb-3">
                                <div class="text-900 font-medium">{{ getSituationLabel(situation) }}</div>
                                <div class="w-2rem h-2rem flex align-items-center justify-content-center border-circle"
                                     [ngClass]="'bg-' + getSituationColor(situation) + '-100'">
                                    <i [ngClass]="['pi', getSituationIcon(situation), 'text-' + getSituationColor(situation) + '-500']"></i>
                                </div>
                            </div>
                            
                            <div class="text-center mb-3">
                                <div class="text-3xl font-bold text-900">
                                    {{ detailedStats.repartitionParSituationFamiliale[situation] }}
                                </div>
                                <div class="text-600 text-sm">adh√©rents</div>
                            </div>

                            <div class="border-top-1 surface-border pt-3">
                                <div class="text-600 text-sm mb-2">R√©partition:</div>
                                <div class="flex justify-content-between mb-1">
                                    <span class="text-sm">Part du total</span>
                                    <span class="font-medium">
                                        {{ getPercentage(detailedStats.repartitionParSituationFamiliale[situation], globalStats?.total || 0) }}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-container>
</div>